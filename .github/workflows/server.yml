jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up server directory
        uses: appleboy/ssh-action@master
        with:
          host: ${{ env.EC2_HOST }}
          username: ${{ env.EC2_USERNAME }}
          key: ${{ env.EC2_PRIVATE_KEY }}
          port: 22
          script: |
            # Kiểm tra và tạo thư mục server nếu chưa tồn tại
            if [ ! -d "/var/www/histudy/server" ]; then
              echo "Directory /var/www/histudy/server does not exist. Creating it now."
              sudo mkdir -p /var/www/histudy/server
            else
              echo "Directory /var/www/histudy/server already exists."
            fi

            # Cấp quyền cho thư mục server ngay cả khi thư mục đã tồn tại
            sudo chown -R ubuntu:ubuntu /var/www/histudy/server
            sudo chmod -R 775 /var/www/histudy/server

      - name: Deploy to EC2 with SCP
        uses: appleboy/scp-action@master
        with:
          host: ${{ env.EC2_HOST }}
          username: ${{ env.EC2_USERNAME }}
          key: ${{ env.EC2_PRIVATE_KEY }}
          port: 22
          source: "server/*"
          target: "/var/www/histudy/server"

      - name: Set up Laravel environment and run deployment tasks
        uses: appleboy/ssh-action@master
        with:
          host: ${{ env.EC2_HOST }}
          username: ${{ env.EC2_USERNAME }}
          key: ${{ env.EC2_PRIVATE_KEY }}
          port: 22
          script: |
            # Tạo file .env và sao chép nội dung từ LARAVEL_ENV vào
            echo "LARAVEL_ENV=${{ env.LARAVEL_ENV }}" | sudo tee /var/www/histudy/server/.env

            # Di chuyển vào thư mục chứa server
            cd /var/www/histudy/server

            # Cài đặt dependencies cho Laravel
            sudo composer install --no-interaction --no-dev --prefer-dist --optimize-autoloader

            # Tạo key cho Laravel
            sudo php artisan key:generate --force

            # Chạy migrate và optimize
            sudo php artisan migrate --force
            sudo php artisan optimize

            # Cấp quyền cho thư mục storage và bootstrap/cache
            sudo chmod -R 775 storage
            sudo chmod -R 775 bootstrap/cache
